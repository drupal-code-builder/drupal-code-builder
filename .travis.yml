language: php
php:
  # No PHP 5, as phpunit does not support it.
  - 7.1

env:
  # Whether to run DCB's internal tests, or integration tests that require a
  # Drupal build.
  - TESTTYPE=dcb
  - TESTTYPE=drupal

install:
  - if [ "$TESTTYPE" = "dcb" ]; then
      composer install;
    fi
  - if [ "$TESTTYPE" = "drupal" ]; then
    # Remove xdebug. We aren't generating code coverage, and it slows down Composer.
      phpenv config-rm xdebug.ini || true

      mysql -e 'create database entity'
      # Export database variable for kernel tests.
      export SIMPLETEST_DB=mysql://root:@127.0.0.1/entity
      # Download Drupal 8 core.
      travis_retry git clone --branch 8.5.x --depth 1 http://git.drupal.org/project/drupal.git
      cd drupal
      composer self-update
      composer install -n

      # Reference DCB in build site.
      ln -s $TESTDIR vendor/drupal-code-builder
      composer require joachim-n/case-converter
    fi

script:
  - if [ "$TESTTYPE" = "dcb" ]; then
      # Only run the unit tests; for the integration tests we need a Drupal
      # install.
      vendor/phpunit/phpunit/phpunit Test/Unit;
    fi
  - if [ "$TESTTYPE" = "drupal" ]; then
      ../vendor/bin/phpunit ../vendor/drupal-code-builder/drupal-code-builder/Test/Integration/CollectPluginInfoTest.php;
   fi
